#!/bin/bash

# Taken from https://github.com/ansibleplaybookbundle/apb-base/blob/master/files/usr/bin/entrypoint.sh

# Work-Around
# The OpenShift's s2i (source to image) requires that no ENTRYPOINT exist
# for any of the s2i builder base images.  Our 's2i-apb' builder uses the
# apb-base as it's base image.  But since the apb-base defines its own
# entrypoint.sh, it is not compatible with the current source-to-image.
#
# The below work-around checks if the entrypoint was called within the
# s2i-apb's 'assemble' script process. If so, it skips the rest of the steps
# which are APB run-time specific.
#
# Details of the issue in the link below:
# https://github.com/openshift/source-to-image/issues/475
#
if [[ $@ == *"s2i/assemble"* ]]; then
  echo "---> Performing S2I build... Skipping cli run"
  exec "$@"
  exit $?
fi

cd "$APP_PATH"  || { echo "$APP_PATH not exists" ; exit 1; }

if [ -f cli ]; then
  CLI_RUN=./cli
elif [ -f bin/cli ]; then
  CLI_RUN=./bin/cli
else
  echo "Please provide cli to run"
  exit 1
fi

if [[ $@ == *"s2i/run"* ]]; then
  exec bundle exec $CLI_RUN
else
  exec bundle exec $CLI_RUN "$@"
fi
